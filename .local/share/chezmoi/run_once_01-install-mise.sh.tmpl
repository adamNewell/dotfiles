#!/bin/bash
# Install mise (universal version manager)
# Runs once per machine

set -e

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

info() { echo -e "${BLUE}ℹ️  $1${NC}"; }
success() { echo -e "${GREEN}✅ $1${NC}"; }
warn() { echo -e "${YELLOW}⚠️  $1${NC}"; }
error() { echo -e "${RED}❌ $1${NC}" >&2; }

# Check if mise is already installed
if command -v mise >/dev/null 2>&1; then
    success "mise is already installed: $(mise --version)"
    exit 0
fi

info "Installing mise (universal version manager)..."

# Download and verify mise installer
readonly MISE_INSTALLER="/tmp/mise_install_$$.sh"
trap 'rm -f "${MISE_INSTALLER}"' EXIT

if ! curl -fsSL "https://mise.run" -o "${MISE_INSTALLER}"; then
    error "Failed to download mise installer"
    exit 1
fi

# Basic verification - check if it's a shell script
if ! head -n1 "${MISE_INSTALLER}" | grep -qE '^#!/(bin/)?(ba)?sh'; then
    error "Downloaded file does not appear to be a valid shell script"
    exit 1
fi

# Execute the installer
sh "${MISE_INSTALLER}"

# Add to PATH for current session
export PATH="${HOME}/.local/bin:${PATH}"

# Verify installation
if command -v mise >/dev/null 2>&1; then
    success "mise installed successfully: $(mise --version)"
    
    # Install tools from .tool-versions if it exists
    if [[ -f "${HOME}/.tool-versions" ]]; then
        info "Installing tools from .tool-versions..."
        mise install
        success "Tools installed via mise"
    fi
else
    error "Failed to install mise"
    exit 1
fi